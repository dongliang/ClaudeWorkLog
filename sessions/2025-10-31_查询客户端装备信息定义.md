# 2025-10-31 查询客户端装备信息定义

## 元信息
- 日期: 2025-10-31
- 项目: GuiRen (鬼刃游戏服务器)
- 主要问题: 查找客户端对装备信息的定义代码

---

## 完整对话

### 对话1

**用户**: 找到客户端对装备信息的定义的代码

**Claude**: 我来帮你找到客户端对装备信息的定义代码。

根据项目规范，装备相关的定义主要在以下几个文件中：
1. `module_def.lua` - 装备模块的数据结构定义
2. `equip_module.lua` - 装备模块的业务实现
3. 配置表相关定义

让我搜索这些文件：

*[使用 Glob 工具搜索了 module_def.lua, equip_module.lua, data_enum.lua 三个文件]*

现在让我读取这些文件来查看装备信息的定义：

*[使用 Read 工具读取了三个文件的完整内容]*

找到了！客户端对装备信息的定义主要在以下三个文件中：

## 1. **装备数据结构定义** - `data_enum.lua`

位置：`D:\99.Resources\2.ProjectLink\21.GuiRen\dev\Client\WuShuang2\Assets\LuaScript\common\data_enum.lua:24-30`

```lua
DataEnum:AddEnum("equipment", {
    base_value = acc(1),      -- 基础值（包含：模板ID、星级、等级、新装备标记、锁定标记）
    distribution = acc(),     -- 成长度（决定装备品质）
    attr_list = acc(),        -- 词条列表
    uuid = acc(),             -- 唯一ID
    ability = acc(),          -- 能力值（包含：链接次数、链接装备ID）
})
```

## 2. **装备模块数据定义** - `module_def.lua`

位置：`D:\99.Resources\2.ProjectLink\21.GuiRen\dev\Client\WuShuang2\Assets\LuaScript\common\module_def.lua:14-24`

```lua
{
    name = "EQUIP",
    script = "equip_module",
    version = 1,
    data = {
        el = {},    -- 装备列表（equipment list）
        ec = 0,     -- 装备数量（equipment count）
        euid = 1,   -- 装备唯一ID（equipment unique id）
        ac = 0,     -- 额外容量（additional capacity）
    },
}
```

## 3. **装备数据编码解析** - `equip_module.lua`

关键函数位置：`equip_module.lua:32-98`

### **base_value 的位字段编码** (32位整数)

```lua
-- 解析函数 (第32-45行)
function ParseEquipBaseValue(base_value)
    local template_id = (base_value >> 16) & 0x0FFF  -- 位16-27: 模板ID（12位）
    local stars = (base_value >> 8) & 0xFF           -- 位8-15:  星级（8位）
    local level = base_value & 0xFF                  -- 位0-7:   等级（8位）
    local is_new = (base_value & 0x80000000) ~= 0    -- 位31:    新装备标记
    local is_lock = (base_value & 0x40000000) ~= 0   -- 位30:    锁定标记
    return template_id, stars, level, is_new, is_lock
end

-- 生成函数 (第85-97行)
function GenEquipBaseValue(template_id, stars, level, is_new, is_lock)
    local value = (template_id << 16) | (stars << 8) | level
    if is_new == 1 then value = value | 0x80000000 end
    if is_lock == 1 then value = value | 0x40000000 end
    return value
end
```

### **ability 的位字段编码** (32位整数)

```lua
-- 解析函数 (第72-79行)
function ParseEquipAblity(info)
    local link_count = info & 0x3FF          -- 位0-9:  链接次数（10位）
    local link_euid = (info >> 10) & 0x3FFFFF -- 位10-31: 链接的装备UID（22位）
    return link_count, link_euid
end
```

### **attr_list 中单个词条的编码** (32位整数)

```lua
-- 解析函数 (第25-30行)
function ParseAttrValue(base_value)
    local level = base_value & 0x7               -- 位0-2:   词条等级（3位）
    local template_id = (base_value >> 8) & 0xFFFF -- 位8-23:  词条模板ID（16位）
    local random_value = base_value >> 24        -- 位24-31: 随机值（8位）
    return template_id, level, random_value
end
```

## 4. **完整装备数据示例**

```lua
el = {
    ["123"] = {  -- euid（装备唯一ID字符串）
        [1] = 0x00010101,  -- base_value: 模板1、1星、1级、非新、未锁定
        [2] = 3300,        -- distribution: 成长度（决定品质为传说）
        [3] = {            -- attr_list: 词条列表
            0x01000001,    -- 第1个词条
            0x02000002,    -- 第2个词条
        },
        [4] = 0,           -- uuid: 服务器UUID（客户端通常为0）
        [5] = 0x00000000,  -- ability: 无链接
    }
}
```

这些定义与服务端的 `EquipmentData.cs` 和 `EquipModule.cs` 必须严格对齐，包括字段索引、位字段布局和编码方式。

---

### 对话2

**用户**: 备份对话

**Claude**: *[正在执行备份操作]*
