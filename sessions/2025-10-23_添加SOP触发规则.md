# [2025-10-23] 添加 SOP 触发规则到项目 CLAUDE.md

## 元信息
- 日期: 2025-10-23
- 项目: GuiRen 游戏服务端
- 主要问题: 如何让 Claude 在特定情况下自动读取 SOP 文档

---

## 完整对话

### 对话1
**用户**: 我希望在项目的CLAUDE.md中增加提示词，当我提到要把某某模块强类型化的的时候使用Read读取doc文件夹下的模块强类型化重构Sop.md文档。当我提到将某些配置数据的业务化的时候你需要使用Read读取doc文件夹下配置数据的业务化Sop.md文档。[Request interrupted by user]我希望在项目的CLAUDE.md中增加触发词，当我提到要把某某模块强类型化的的时候使用Read读取doc文件夹下的模块强类型化重构Sop.md文档。当我提到将某些配置数据的业务化的时候你需要使用Read读取doc文件夹下配置数据的业务化Sop.md文档。并且我希望你在识别到某个需求需要用到相关文档时，也可以主动提醒。

**Claude**: 我理解你的需求。让我先确认一下这两个文档的存在，然后再讨论如何在 CLAUDE.md 中添加触发规则。

[使用 Glob 工具查找 doc/*.md]

很好，两个文档都存在。现在让我先阅读这两个文档，了解它们的具体内容，以便更好地设计触发规则：

[使用 Read 工具读取两个 SOP 文档]

好的，我已经阅读了两个 SOP 文档。现在我理解你的需求了:

## 需求理解

你希望在 `CLAUDE.md` 中添加触发规则,当:
1. **触发词识别**: 你提到"模块强类型化"或"配置数据业务化"时,我会自动读取对应的 SOP 文档
2. **主动识别**: 当我判断某个需求适合使用这些 SOP 时,我也会主动提醒并读取相关文档

## 方案设计

我建议在 `CLAUDE.md` 中添加一个新的章节,放在 **"## 开发注意事项"** 之后,具体内容如下:

### 方案内容

```markdown
## 开发流程 SOP

### 模块强类型化重构

**触发条件**:
- 用户明确提到"模块强类型化"、"强类型化XXX模块"、"将XXX模块改为强类型"等关键词
- 用户要求修改 PlayerState 中的 Dictionary<string, object> 模块为强类型类
- 我判断当前需求需要创建/修改模块的数据结构(如 EquipModule, EconomicModule 等)

**执行动作**:
1. **必须先读取**: 使用 Read 工具读取 `doc/模块强类型化重构Sop.md`
2. **严格遵循**: 按照 SOP 的 4 个阶段执行(理解现有实现 → 设计强类型结构 → 实现代码 → 验证实现)
3. **关键检查**: 确保与客户端 module_def.lua 和 data_enum.lua 完全对齐

**核心原则**: 完全客户端兼容 / 零冗余设计 / 类型安全 / 业务封装

---

### 配置数据的业务化

**触发条件**:
- 用户明确提到"配置数据业务化"、"为XXX配置表添加业务方法"、"实现XXX表的 Override"等关键词
- 用户要求在 `src/Project.Grains/Config/Overrides` 中添加/修改配置类
- 我判断当前需求需要为配置表建立索引、添加业务方法或解析复杂字段

**执行动作**:
1. **必须先读取**: 使用 Read 工具读取 `doc/配置数据的业务化Sop.md`
2. **严格遵循**: 按照 SOP 的 6 个阶段执行(调研与分析 → 设计确认 → 代码实现 → 验证对齐 → 编写测试 → 交付)
3. **关键输出**: 阶段 1 完成后必须输出结构化的设计清单,等待用户明确确认后再进入实现阶段

**核心原则**: 性能优先(空间换时间) / 零冗余 / 职责清晰 / 客户端对齐

---

### 主动识别与提醒

当我发现以下情况时,会主动提醒并询问是否需要使用对应的 SOP:

**模块强类型化场景**:
- 需要修改 PlayerState 的模块字段类型
- 需要创建新的 XXXModule 类或 XXXData 类
- 需要处理位字段(bit field)操作
- 需要确保 JSON 序列化索引与客户端对齐

**配置数据业务化场景**:
- 需要为配置表建立查询索引
- 需要解析配置表中的字符串编码数据(如 "id1:num1;id2:num2")
- 需要实现配置表的业务查询方法
- 需要处理跨表引用关系
- 需要实现策略模式(根据配置字段值选择不同逻辑)
```

## 方案优点

1. **明确触发条件**: 既有用户明确提到的关键词,也有我主动判断的场景
2. **清晰的执行流程**: 告诉我必须先读取 SOP,然后严格遵循
3. **突出核心原则**: 快速提醒关键设计原则
4. **双向机制**: 既支持被动触发(你提到),也支持主动识别(我判断)

## 接下来

我可以帮你把这个内容添加到 `CLAUDE.md` 中,位置建议放在 **"## 开发注意事项"** 之后、**"## 代码风格"** 之前。

你觉得这个方案如何?是否需要调整?

### 对话2
**用户**: 我不希望你提到太多文档本身的内容，因为那样就重复了。我只想让你清晰的写出在什么情况下需要Read

**Claude**: 理解了！你只想要简洁的触发规则，不要重复 SOP 的内容。让我重新设计：

## 方案

在 `CLAUDE.md` 的 **"## 开发注意事项"** 之后添加一个简洁的章节：

```markdown
## 开发流程 SOP 触发规则

### 模块强类型化重构

**何时读取 `doc/模块强类型化重构Sop.md`**:
- 用户提到"模块强类型化"、"强类型化XXX模块"、"将XXX模块改为强类型"
- 需要修改 PlayerState 中的 `Dictionary<string, object>` 为强类型类
- 需要创建/修改 XXXModule 或 XXXData 类
- 需要处理位字段或确保 JSON 序列化索引与客户端对齐

---

### 配置数据的业务化

**何时读取 `doc/配置数据的业务化Sop.md`**:
- 用户提到"配置数据业务化"、"为XXX配置表添加业务方法"、"实现XXX表的 Override"
- 需要在 `Config/Overrides` 中添加/修改配置类
- 需要为配置表建立索引或添加业务查询方法
- 需要解析配置表中的字符串编码数据
- 需要处理跨表引用或实现策略模式
```

## 特点

1. **极简**: 只说"什么情况下读取文档"，不重复文档内容
2. **清晰**: 列出具体的触发场景，容易判断
3. **可执行**: 触发条件明确，不会遗漏

这样可以吗？如果可以，我直接添加到 CLAUDE.md 中。

### 对话3
**用户**: 我需要让你写成 当某某某某情况发生时，务必读取某某某。或者你推荐一种一定会准确触发的触发词

**Claude**: 理解了！我需要用强制性的语言，确保准确触发。让我设计：

## 方案

```markdown
## 开发流程 SOP 触发规则

### 模块强类型化重构

**强制触发规则**:
- 当用户使用触发词"**强类型化**"时，务必读取 `doc/模块强类型化重构Sop.md`
- 当需要修改 PlayerState 中的模块字段类型或创建 XXXModule/XXXData 类时，务必读取该文档

---

### 配置数据的业务化

**强制触发规则**:
- 当用户使用触发词"**业务化**"时，务必读取 `doc/配置数据的业务化Sop.md`
- 当需要在 `Config/Overrides` 中添加/修改配置类时，务必读取该文档
```

## 推荐触发词

- **模块强类型化** → 触发词: "**强类型化**"
  - 示例: "强类型化装备模块"、"把背包模块强类型化"

- **配置数据业务化** → 触发词: "**业务化**"
  - 示例: "业务化 drop_group 配置表"、"将装备表业务化"

这样设计的优点：
1. **触发词简洁明确**: "强类型化"、"业务化" 都是你已经在使用的术语
2. **强制性语言**: 用"务必读取"确保我不会遗漏
3. **双重保障**: 既有触发词，也有场景描述

你觉得这样可以吗？

### 对话4
**用户**: 可以

**Claude**: [使用 Read 工具读取 CLAUDE.md]

[使用 Edit 工具在 CLAUDE.md 中添加触发规则章节]

完成！我已经在 CLAUDE.md 中添加了触发规则章节，位置在"数据同步机制"之后、"开发注意事项"之前。

## 添加的内容

**触发词**:
- "**强类型化**" → 读取 `doc/模块强类型化重构Sop.md`
- "**业务化**" → 读取 `doc/配置数据的业务化Sop.md`

**触发场景**:
- 修改 PlayerState 模块字段 / 创建 XXXModule 或 XXXData 类
- 在 `Config/Overrides` 中添加/修改配置类

以后你说"强类型化装备模块"或"业务化 drop_group 配置表"时，我就会自动读取对应的 SOP 文档了。

### 对话5
**用户**: 备份鬼刃md

**Claude**: [使用 Bash 工具检查文件和目录是否存在]

[使用 Bash 工具复制 CLAUDE.md 和 doc 目录到备份位置]

[使用 Bash 工具提交并推送到 git 仓库]

✅ 备份完成！

已成功备份到 `D:\99.Resources\2.ProjectLink\33.Project.CLAUDE.MD` 并推送到 git 仓库。

**备份内容**:
- `CLAUDE.md` - 更新了"开发流程 SOP 触发规则"章节
- `doc/` 目录 - 包含两个 SOP 文档

**提交信息**: 更新 GuiRen 项目协作规范和文档 - 添加开发流程 SOP 触发规则

### 对话6
**用户**: 备份对话

**Claude**: [当前正在执行备份对话操作]
