# 2025-10-16 æ‰è½ç³»ç»Ÿé‡æ„ - IRolleræ¥å£è§£è€¦

## å…ƒä¿¡æ¯
- **æ—¥æœŸ**: 2025-10-16
- **é¡¹ç›®**: GuiRen.Server (æ¸¸æˆæœåŠ¡å™¨)
- **æŠ€æœ¯æ ˆ**: C#, .NET 9, Orleans
- **ä¸»è¦é—®é¢˜**: é‡æ„æ‰è½ç³»ç»Ÿ,å°†ç¡¬ç¼–ç çš„éšæœºå™¨é€»è¾‘æŠ½è±¡ä¸ºæ¥å£,æ”¯æŒå¤šç§éšæœºå™¨ç±»å‹
- **ç»“æœ**: âœ…æˆåŠŸ

---

## é—®é¢˜èƒŒæ™¯

ç”¨æˆ·æƒ³è¦ä¼˜åŒ– `BattleModule.cs` ä¸­çš„ `CalculateDrops` å‡½æ•°(å®é™…ä½äº `drop_group.cs`)ã€‚è¿™ä¸ªå‡½æ•°ç”¨äºå•æ¬¡æ‰è½æŠ½å–(å¦‚å‡»æ€ä¸€ä¸ªæ€ªç‰©),ä½†å­˜åœ¨ä»¥ä¸‹é—®é¢˜:

1. **å‡½æ•°åä¸æ¸…æ™°**: `CalculateDrops` (å¤æ•°)å®¹æ˜“è¯¯è§£ä¸º"è®¡ç®—å¤šæ¬¡æ‰è½"
2. **éšæœºå™¨é€»è¾‘ç¡¬ç¼–ç **: åªæ”¯æŒ `normal` (æ¦‚ç‡åˆ¤å®š),æ— æ³•æ‰©å±•
3. **èŒè´£ä¸æ¸…**: `randomId` å’Œ `randomParams` çš„å…³ç³»æ¨¡ç³Š,ä¸åŒéšæœºå™¨éœ€æ±‚ä¸åŒ
   - `normal`: `randomParams` æ˜¯æ¦‚ç‡å€¼ (å¦‚ "0.5")
   - `pet_ticket`: `randomParams` æ˜¯æ•°é‡èŒƒå›´ (å¦‚ "{300,900}")

ç”¨æˆ·å¸Œæœ›:
- æ›´å¥½çš„å‡½æ•°åå’Œæ³¨é‡Š
- è§£è€¦éšæœºå™¨é€»è¾‘,æ”¯æŒæ‰©å±•
- ç®€æ´ä¼˜é›…çš„å®ç°

---

## å·¥ä½œè¿‡ç¨‹

### 1. ç†è§£é—®é¢˜é˜¶æ®µ

- **å‘ç°çš„å…³é”®ä¿¡æ¯**:
  - `CalculateDrops` å®é™…æ˜¯"å•æ¬¡æ‰è½æŠ½å–",ä¸æ˜¯"å¤šæ¬¡"
  - ä¸€ä¸ª `(stageId, dropTag)` å¯ä»¥é…ç½®å¤šä¸ª `drop_group`,æ¯ä¸ªç‹¬ç«‹åˆ¤å®š
  - `loopCount` æ”¯æŒ"å¤šæ¬¡æŠ½å¥–"æœºåˆ¶
  - `randomId` ä¸æ˜¯å¼€å…³,è€Œæ˜¯éšæœºå™¨ç±»å‹æ ‡è¯†
  - ä¸åŒéšæœºå™¨æœ‰ä¸åŒçš„å‰¯ä½œç”¨:
    - `normal`: å½±å“"æ˜¯å¦è§¦å‘" (è¿”å› bool)
    - `pet_ticket`: å½±å“"æ‰è½æ•°é‡" (è¿”å› int)

- **æ ¸å¿ƒçŸ›ç›¾**: ä¸¤ç§éšæœºå™¨çš„è¿”å›å€¼ç±»å‹ä¸åŒ,å¦‚ä½•ç”¨ç»Ÿä¸€æ¥å£?

### 2. æ–¹æ¡ˆè®¾è®¡é˜¶æ®µ

- **æ–¹æ¡ˆå¯¹æ¯”**:
  - **æ–¹æ¡ˆA - ç»“æ„ä½“**: è¿”å› `RollResult { bool Ok, int Count }`
    - ä¼˜ç‚¹: è¯­ä¹‰æ¸…æ™°
    - ç¼ºç‚¹: éœ€è¦è‡ªå®šä¹‰ç»“æ„ä½“,ä»£ç ç¨å¤š

  - **æ–¹æ¡ˆB - intå€¼**: è¿”å› `int`,0è¡¨ç¤ºä¸è§¦å‘,>0è¡¨ç¤ºæ•°é‡å€æ•°
    - ä¼˜ç‚¹: æç®€,æ— éœ€é¢å¤–ç±»å‹
    - ç¼ºç‚¹: 0çš„è¯­ä¹‰ä¸å¤Ÿæ˜ç¡®

  - **æ–¹æ¡ˆC - Nullable**: è¿”å› `int?`,nullè¡¨ç¤ºä¸è§¦å‘
    - ä¼˜ç‚¹: nullè¯­ä¹‰æ¸…æ™°,C#åŸç”Ÿæ”¯æŒ
    - ç¼ºç‚¹: éœ€è¦ `.Value` è®¿é—®

- **æœ€ç»ˆé€‰æ‹©**: æ–¹æ¡ˆB (intå€¼)
- **é€‰æ‹©ç†ç”±**: ç”¨æˆ·æ˜ç¡®è¦æ±‚"æ›´å°‘çš„å­—ã€æ›´ç®€å•",æ–¹æ¡ˆBä»£ç æœ€ç®€æ´

### 3. å®ç°é˜¶æ®µ

- **æ ¸å¿ƒè®¾è®¡**:
  ```csharp
  // æ¥å£å®šä¹‰
  public interface IRoller
  {
      int Roll(string param, Random random); // 0=ä¸è§¦å‘, >0=å€æ•°
  }

  // Normaléšæœºå™¨ - æ”¯æŒåŒæ¨¡å¼
  class NormalRoller : IRoller
  {
      public int Roll(string param, Random random)
      {
          if (!float.TryParse(param, out var value))
              return 0;

          if (value < 1)
              return random.NextDouble() <= value ? 1 : 0; // æ¦‚ç‡æ¨¡å¼

          return (int)value; // å›ºå®šå€æ•°æ¨¡å¼
      }
  }

  // Rangeéšæœºå™¨
  class RangeRoller : IRoller
  {
      public int Roll(string param, Random random)
      {
          // è§£æ "{300,900}" è¿”å› 300-900 éšæœºå€¼
          var nums = param.Trim('{', '}').Split(',');
          if (nums.Length != 2) return 0;

          var min = int.Parse(nums[0].Trim());
          var max = int.Parse(nums[1].Trim());
          return random.Next(min, max + 1);
      }
  }
  ```

- **å…³é”®æ”¹è¿›ç‚¹**:
  1. å‡½æ•°é‡å‘½å: `CalculateDrops` â†’ `RollDrop`
  2. æ·»åŠ æ¸…æ™°æ³¨é‡Š: è¯´æ˜"å•æ¬¡æ‰è½"æ¦‚å¿µ,é™„å¸¦ä½¿ç”¨ç¤ºä¾‹
  3. åŠ¨æ€è°ƒç”¨éšæœºå™¨: æ ¹æ® `randomId` æŸ¥å­—å…¸è·å–å¯¹åº” `IRoller`
  4. ç»Ÿä¸€è®¡ç®—é€»è¾‘: `æœ€ç»ˆæ•°é‡ = åŸºç¡€æ•°é‡ Ã— éšæœºå™¨å€æ•°`

- **NormalRoller çš„åŒæ¨¡å¼æ”¯æŒ** (ç”¨æˆ·è¿½åŠ éœ€æ±‚):
  - å‚æ•° < 1: æ¦‚ç‡åˆ¤å®š (å¦‚ 0.5 â†’ 50%æ¦‚ç‡è¿”å›1)
  - å‚æ•° â‰¥ 1: å›ºå®šå€æ•° (å¦‚ 25 â†’ å¿…å®šè¿”å›25)

- **ç¼–è¯‘éªŒè¯**: 0ä¸ªé”™è¯¯,ä»£ç å‡€å‡å°‘28è¡Œ (101+ / 129-)

---

## æ”¶è·ä¸åæ€

### âœ… åšå¾—å¥½çš„åœ°æ–¹
- **æ–¹æ¡ˆè®¨è®ºå……åˆ†**: æä¾›äº†3ä¸ªæ–¹æ¡ˆä¾›ç”¨æˆ·é€‰æ‹©,æ¯ä¸ªæ–¹æ¡ˆéƒ½è¯´æ˜äº†ä¼˜ç¼ºç‚¹
- **å‘½åä¼˜åŒ–**: `RollDrop` æ¯” `CalculateDrops` æ›´ç¬¦åˆæ¸¸æˆå¼€å‘æœ¯è¯­("roll" for loot)
- **æ³¨é‡Šç²¾å‡†**: åªåœ¨å…³é”®çš„ã€æ˜“äº§ç”Ÿæ­§ä¹‰çš„åœ°æ–¹æ·»åŠ æ³¨é‡Š,ä¸å†—ä½™
- **å¿«é€Ÿè¿­ä»£**: æ ¹æ®ç”¨æˆ·åé¦ˆ(NormalRolleråŒæ¨¡å¼)å¿«é€Ÿè°ƒæ•´å®ç°

### âš ï¸ å¯ä»¥æ”¹è¿›çš„åœ°æ–¹
- æœ€åˆè¯¯è§£äº† `randomId` çš„å«ä¹‰(ä»¥ä¸ºæ˜¯å¼€å…³,å®é™…æ˜¯ç±»å‹æ ‡è¯†)
- ç¬¬ä¸€æ¬¡æ–¹æ¡ˆè®¾è®¡æ—¶æ²¡æœ‰è€ƒè™‘åˆ° `NormalRoller` éœ€è¦æ”¯æŒå›ºå®šå€æ•°æ¨¡å¼

### ğŸ’¡ æ–°çš„è®¤çŸ¥
- **æ¸¸æˆæ‰è½ç³»ç»Ÿçš„è®¾è®¡æ¨¡å¼**:
  - è§¦å‘åˆ¤å®šå’Œæ•°é‡è®¡ç®—å¯ä»¥ç»Ÿä¸€ç”¨"å€æ•°"æ¦‚å¿µè¡¨è¾¾
  - 0ä½œä¸ºç‰¹æ®Šå€¼è¡¨ç¤º"ä¸è§¦å‘",>0è¡¨ç¤ºå€æ•°,ç®€æ´ä¸”é«˜æ•ˆ
- **å‘½åçš„é‡è¦æ€§**:
  - `RollDrop` vs `CalculateDrops`: å‰è€…ä¸€çœ¼çœ‹å‡ºæ˜¯"å•æ¬¡",åè€…å®¹æ˜“è¯¯è§£
  - `IRoller` vs `IDropRandomizer`: å‰è€…çŸ­å°æ˜“è®°
- **ç®€åŒ–ä¼˜äºå¤æ‚**:
  - ç”¨æˆ·å¤šæ¬¡å¼ºè°ƒ"æ›´ç®€æ´",æœ€ç»ˆé€‰æ‹©äº†intè€Œéç»“æ„ä½“
  - å°‘å³æ˜¯å¤š,3ä¸ªç±»æ–‡ä»¶(IRoller, NormalRoller, RangeRoller)å°±è§£å†³äº†é—®é¢˜

### ğŸ“Œ å¯å¤ç”¨çš„æ¨¡å¼/æœ€ä½³å®è·µ
- **ç­–ç•¥æ¨¡å¼ + å­—å…¸å·¥å‚**:
  ```csharp
  private static readonly Dictionary<string, IRoller> _rollers = new()
  {
      ["normal"] = new NormalRoller(),
      ["range"] = new RangeRoller(),
  };
  ```
  é€‚ç”¨äºéœ€è¦æ ¹æ®é…ç½®åŠ¨æ€é€‰æ‹©ç®—æ³•çš„åœºæ™¯

- **ç”¨è¿”å›å€¼è¡¨è¾¾å¤šç§è¯­ä¹‰**:
  - 0 = å¤±è´¥/ä¸è§¦å‘
  - >0 = æˆåŠŸä¸”æºå¸¦æ•°å€¼ä¿¡æ¯
  - é¿å…äº†å¤æ‚çš„è¿”å›ç±»å‹

- **åŒæ¨¡å¼è®¾è®¡**:
  - `NormalRoller` æ ¹æ®å‚æ•°èŒƒå›´(<1 æˆ– â‰¥1)è‡ªåŠ¨åˆ‡æ¢è¡Œä¸º
  - ä¸€ä¸ªç±»æ”¯æŒä¸¤ç§ç”¨é€”,å‡å°‘ç±»æ•°é‡

---

## ç›¸å…³é“¾æ¥
- **ä»£ç æäº¤**: `5bf49285a05b50e02d047f425be910147bb87e7b`
- **ä¿®æ”¹æ–‡ä»¶**:
  - `Server/src/Project.Grains/Config/Overrides/IRoller.cs` (æ–°å¢)
  - `Server/src/Project.Grains/Config/Overrides/drop_group.cs` (é‡æ„)
  - `Server/src/Project.Grains/Config/Overrides/reward_pool.cs` (åˆ é™¤æœªä½¿ç”¨ä»£ç )

---

## æ ‡ç­¾
#CSharp #æ¸¸æˆå¼€å‘ #æ‰è½ç³»ç»Ÿ #ç­–ç•¥æ¨¡å¼ #é‡æ„ #Orleans #.NET9
