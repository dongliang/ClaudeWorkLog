# [2025-10-23] 添加 SOP 触发规则 - 分析报告

## 1. 问题背景

用户已经在项目的 `doc/` 目录下创建了两个详细的 SOP 文档：
- `模块强类型化重构Sop.md` - 指导如何将弱类型模块转换为强类型
- `配置数据的业务化Sop.md` - 指导如何为配置表添加索引和业务方法

问题是：如何让 Claude 在合适的时机自动读取这些 SOP 文档，而不是每次都需要手动提醒？

**核心需求**：
1. 建立明确的触发机制 - 让 Claude 知道什么时候该读取哪个 SOP
2. 触发词要简洁准确 - 避免误触发或遗漏
3. 避免冗余 - 不要在 CLAUDE.md 中重复 SOP 的内容

---

## 2. 方案讨论

### 方案演进过程

**第一版方案（被拒绝）**：
- 在 CLAUDE.md 中详细描述触发条件、执行动作、核心原则
- 包含了大量 SOP 内容的摘要
- **问题**：重复了 SOP 文档的内容，违反 DRY 原则

**第二版方案（被拒绝）**：
- 简化为"何时读取"格式
- 列出多个触发场景
- **问题**：没有使用强制性语言，触发条件不够明确

**最终方案（被采纳）**：
- 使用"**强制触发规则**"标题，突出强制性
- 推荐明确的触发词："强类型化"、"业务化"
- 用"务必读取"确保执行
- 双重保障：既有触发词，也有场景描述

### 为什么最终方案有效

1. **触发词选择精准**：
   - "强类型化" 和 "业务化" 都是用户已经在使用的术语
   - 词汇本身具有明确的语义边界，不容易误触发
   - 简短（3-4 个字），便于记忆和使用

2. **强制性语言**：
   - "务必读取" 比 "建议读取" 或 "可以读取" 更有约束力
   - 明确告诉 Claude 这是必须执行的动作，不是可选项

3. **双重触发机制**：
   - 主触发：用户使用触发词
   - 辅助触发：场景匹配（修改特定目录/文件时）
   - 降低了遗漏的风险

---

## 3. 用户决策复盘

### 用户完整发言列表

1. **第一次发言**（被用户自己中断）：
   > "我希望在项目的CLAUDE.md中增加提示词，当我提到要把某某模块强类型化的的时候使用Read读取doc文件夹下的模块强类型化重构Sop.md文档。当我提到将某些配置数据的业务化的时候你需要使用Read读取doc文件夹下配置数据的业务化Sop.md文档。[Request interrupted by user]"

2. **第二次发言**（完整需求）：
   > "我希望在项目的CLAUDE.md中增加触发词，当我提到要把某某模块强类型化的的时候使用Read读取doc文件夹下的模块强类型化重构Sop.md文档。当我提到将某些配置数据的业务化的时候你需要使用Read读取doc文件夹下配置数据的业务化Sop.md文档。并且我希望你在识别到某个需求需要用到相关文档时，也可以主动提醒。"

3. **第三次发言**（拒绝第一版方案）：
   > "我不希望你提到太多文档本身的内容，因为那样就重复了。我只想让你清晰的写出在什么情况下需要Read"

4. **第四次发言**（要求强制性语言）：
   > "我需要让你写成 当某某某某情况发生时，务必读取某某某。或者你推荐一种一定会准确触发的触发词"

5. **第五次发言**（确认方案）：
   > "可以"

6. **第六次发言**（执行备份）：
   > "备份鬼刃md"

7. **第七次发言**（备份对话）：
   > "备份对话"

### 关键决策分析

#### 决策点 1：拒绝第一版详细方案

**已考虑的因素**：
- ✅ 用户明确表达不想要重复 SOP 内容
- ✅ 用户强调"只想让你清晰的写出在什么情况下需要Read"

**可进一步考量的因素**：
- 💡 **信息层次设计**：可以考虑在 CLAUDE.md 中只保留触发规则，在 SOP 文档开头添加"适用场景"摘要，形成两级信息架构
  - CLAUDE.md：何时读取（触发层）
  - SOP 文档：读取后做什么（执行层）
  - 这样既避免重复，又能让 SOP 文档本身更独立完整

**表述优化建议**：
- 当前表述："我不希望你提到太多文档本身的内容"
- 优化表述："CLAUDE.md 只负责触发规则，SOP 文档负责执行细节，保持单一职责"
- **优化原因**：用设计原则（单一职责）来解释需求，让未来类似场景的决策更有原则性指引

#### 决策点 2：要求强制性语言和明确触发词

**已考虑的因素**：
- ✅ 用户意识到触发规则的可靠性很重要
- ✅ 用户希望有"一定会准确触发"的机制

**可进一步考量的因素**：
- 💡 **触发词的扩展性**：当未来有第三个、第四个 SOP 时，如何命名触发词？
  - 建议：建立触发词命名规范，如"动作+对象"模式
  - "强类型化" = 强类型化 + [模块]
  - "业务化" = 业务化 + [配置表]
  - 未来如："协议化"、"测试化"等

- 💡 **触发失败的补救机制**：如果用户忘记使用触发词怎么办？
  - 可以在 CLAUDE.md 中添加："当 Claude 判断需要使用 SOP 但用户未提及触发词时，主动询问是否需要遵循相关 SOP"
  - 这是一个防御性设计

**思考盲区**：
- ⚠️ **触发词冲突风险**：如果未来有其他文档也用"业务化"怎么办？
  - 建议：在 CLAUDE.md 的触发规则章节开头添加："触发词具有唯一性，当添加新 SOP 时需检查触发词是否冲突"

- ⚠️ **多 SOP 组合场景**：如果一个任务同时需要"强类型化"和"业务化"两个 SOP 怎么办？
  - 建议：允许在一个任务描述中使用多个触发词，Claude 应该读取所有相关 SOP
  - 示例："强类型化装备模块，并业务化装备配置表"

#### 决策点 3：快速确认并执行

**已考虑的因素**：
- ✅ 用户对最终方案满意，直接说"可以"
- ✅ 用户信任 Claude 的实现能力

**可进一步考量的因素**：
- 💡 **验证环节**：是否需要在实施后验证触发规则是否真的有效？
  - 建议：下次真正使用触发词时，观察 Claude 是否自动读取了 SOP
  - 如果没有，说明 CLAUDE.md 的指令不够强或者位置不对

---

## 4. 收获与反思

### 亮点与改进

**用户的亮点**：
- ✅ **迭代反馈清晰**：每次都明确指出方案的问题（"太重复"、"不够强制"）
- ✅ **需求表达精准**：从"提示词"到"触发词"到"务必读取"，逐步明确需求
- ✅ **信任执行**：确认方案后直接说"可以"，不过度干预实现细节

**用户可改进的地方**：
- 💡 第一次发言被自己中断，可能是在思考过程中发现表达不完整
- 💡 可以在需求明确后，主动询问"是否需要验证触发规则的有效性"

**Claude 的亮点**：
- ✅ **方案迭代快速**：根据反馈快速调整方案
- ✅ **理解用户意图**：准确理解"不要重复内容"的本质是保持简洁
- ✅ **主动提供建议**：推荐了明确的触发词而不是让用户自己想

**Claude 可改进的地方**：
- 💡 第一版方案过于详细，应该更早理解"极简"的需求
- 💡 可以主动提出触发词冲突、多 SOP 组合等边界情况

### 新的认知

#### 技术/方法论层面

1. **触发机制设计的三要素**：
   - **明确的触发词**：简短、语义清晰、不易冲突
   - **强制性语言**：用"务必"而不是"可以"
   - **场景补充**：触发词 + 场景描述，双重保障

2. **文档分层原则**：
   - CLAUDE.md：触发规则（何时做）
   - SOP 文档：执行细节（如何做）
   - 避免层次混淆和内容重复

3. **指令的可靠性设计**：
   - 对于关键流程，不能依赖 AI 的"理解"，必须有明确的触发机制
   - "务必">"应该">"可以"

#### 协作层面

1. **需求明确化的迭代过程**：
   - 用户的第一次表达往往不是最清晰的
   - 通过方案展示 → 反馈 → 调整的循环，逐步达成共识

2. **信任与放手**：
   - 当方案确认后，用户直接说"可以"而不是要求看代码
   - 这种信任建立在之前多次成功协作的基础上

### 可复用模式

1. **触发规则模板**：
   ```markdown
   ## [功能名] SOP 触发规则

   **强制触发规则**:
   - 当用户使用触发词"**[触发词]**"时，务必读取 `[文档路径]`
   - 当需要 [特定场景描述] 时，务必读取该文档
   ```

2. **方案迭代流程**：
   - 第一版：尽量详细，展示思考过程
   - 根据反馈：快速调整，抓住核心需求
   - 最终版：简洁、强制、可执行

3. **文档备份的标准流程**：
   - 检查文件/目录是否存在
   - 复制到备份位置
   - Git 提交并推送
   - 静默执行（项目在例外列表中）

### 待优化规范

以下建议可直接添加到 CLAUDE.md：

1. **触发词管理规范**：
   ```markdown
   ### 触发词管理

   - **唯一性原则**：每个触发词只能对应一个 SOP 文档
   - **命名规范**：使用"动作+对象"模式（如"强类型化"="强类型化+模块"）
   - **冲突检查**：添加新 SOP 时，必须检查触发词是否与现有触发词冲突
   - **组合使用**：一个任务可以包含多个触发词，Claude 应读取所有相关 SOP
   ```

2. **触发规则验证机制**：
   ```markdown
   ### 触发规则验证

   - 当 Claude 判断某任务需要遵循 SOP，但用户未使用触发词时：
     1. 主动询问："这个任务是否需要遵循 [SOP名称]？"
     2. 如果用户确认，读取对应 SOP 并执行
   - 这是一个防御性机制，防止因遗漏触发词导致流程不规范
   ```

3. **SOP 文档编写规范**：
   ```markdown
   ### SOP 文档结构

   每个 SOP 文档应包含：
   1. **标题**：清晰说明这个 SOP 的用途
   2. **适用场景**：一句话描述什么情况下使用这个 SOP
   3. **核心原则**：3-5 条关键原则
   4. **执行流程**：分阶段的详细步骤
   5. **检查清单**：用于自检和验收
   ```

---

## 5. 原始对话链接

完整对话记录：[sessions/2025-10-23_添加SOP触发规则.md](sessions/2025-10-23_添加SOP触发规则.md)

---

## 总结

这次协作的核心价值在于：**建立了一套可靠的触发机制，让复杂的 SOP 流程能够被准确地执行**。

通过三轮方案迭代，我们找到了触发规则设计的最佳实践：
1. 极简触发词（"强类型化"、"业务化"）
2. 强制性语言（"务必读取"）
3. 双重保障（触发词 + 场景描述）

这个模式可以复用到未来所有需要"在特定情况下自动触发某个流程"的场景中。

**关键教训**：
- 不要在触发规则中重复执行细节，保持分层清晰
- 对于关键流程，必须有明确的强制性触发机制
- 简洁的触发词胜过复杂的场景描述
